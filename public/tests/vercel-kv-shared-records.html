<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vercel KV ê³µìœ  ê¸°ë¡ í…ŒìŠ¤íŠ¸ â€” Arcane Archive</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-stone-900 text-stone-100 min-h-screen p-6">
  <div class="max-w-4xl mx-auto">
    <h1 class="text-2xl font-bold mb-2">Vercel KV ê³µìœ  ê¸°ë¡ í…ŒìŠ¤íŠ¸</h1>
    <p class="text-stone-400 text-sm mb-6">
      Vercel KVë¥¼ ì‚¬ìš©í•œ ê³µìœ  ê¸°ë¡ ì €ì¥Â·ì¡°íšŒÂ·ì‚­ì œ ê¸°ëŠ¥ì„ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.
      <br/>
      <span class="text-amber-400">âš ï¸ Vercel KV í™˜ê²½ ë³€ìˆ˜(KV_URL, KV_REST_API_URL, KV_REST_API_TOKEN)ê°€ ì„¤ì •ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.</span>
    </p>

    <div class="mb-4 p-4 rounded-lg bg-amber-950/40 border border-amber-800/50 text-stone-300 text-sm">
      <h2 class="text-amber-500/90 font-semibold mb-2">í™˜ê²½ ì„¤ì •</h2>
      <p class="mb-2">Vercel KVë¥¼ ì‚¬ìš©í•˜ë ¤ë©´ ë‹¤ìŒ í™˜ê²½ ë³€ìˆ˜ê°€ í•„ìš”í•©ë‹ˆë‹¤:</p>
      <ul class="list-disc list-inside space-y-1 text-xs text-stone-400">
        <li><code class="bg-stone-800 px-1 rounded">KV_URL</code> ë˜ëŠ”</li>
        <li><code class="bg-stone-800 px-1 rounded">KV_REST_API_URL</code> + <code class="bg-stone-800 px-1 rounded">KV_REST_API_TOKEN</code></li>
      </ul>
      <p class="mt-2 text-xs text-stone-500">ë¡œì»¬ í…ŒìŠ¤íŠ¸: <code class="bg-stone-800 px-1 rounded">.env</code> íŒŒì¼ì— ì„¤ì •í•˜ì„¸ìš”.</p>
    </div>

    <div class="grid md:grid-cols-2 gap-6 mb-6">
      <!-- ê³µìœ  ê¸°ë¡ ì¶”ê°€ -->
      <div class="p-4 rounded-lg bg-stone-800/50 border border-stone-700">
        <h2 class="text-lg font-semibold text-amber-600/90 mb-4">ê³µìœ  ê¸°ë¡ ì¶”ê°€</h2>
        <div class="space-y-3">
          <div>
            <label class="block text-stone-400 text-sm mb-1">ì‘í’ˆëª…</label>
            <input type="text" id="recordTitle" placeholder="ì˜ˆ: ì¥ì†¡ì˜ í”„ë¦¬ë Œ"
              class="w-full rounded-lg bg-stone-800 border border-stone-600 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-amber-500" />
          </div>
          <div>
            <label class="block text-stone-400 text-sm mb-1">ê³µìœ  íƒ€ì…</label>
            <select id="recordType" class="w-full rounded-lg bg-stone-800 border border-stone-600 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-amber-500">
              <option value="qa">Q&A (ì§ˆë¬¸+ë‹µë³€)</option>
              <option value="book">ì±… ì „ì²´</option>
            </select>
          </div>
          <div id="qaFields">
            <div>
              <label class="block text-stone-400 text-sm mb-1">ì§ˆë¬¸</label>
              <input type="text" id="recordQ" placeholder="ì˜ˆ: ê°€ì¥ ì¸ìƒ ê¹Šì—ˆë˜ ì¥ë©´ì€?"
                class="w-full rounded-lg bg-stone-800 border border-stone-600 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-amber-500" />
            </div>
            <div>
              <label class="block text-stone-400 text-sm mb-1">ë‹µë³€</label>
              <textarea id="recordA" rows="2" placeholder="ì˜ˆ: í˜ë©œê³¼ì˜ 10ë…„..."
                class="w-full rounded-lg bg-stone-800 border border-stone-600 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-amber-500 resize-none"></textarea>
            </div>
          </div>
          <div id="bookFields" style="display: none;">
            <div>
              <label class="block text-stone-400 text-sm mb-1">ì§ˆë¬¸ ê°œìˆ˜</label>
              <input type="number" id="recordQCount" value="5" min="1" max="50"
                class="w-full rounded-lg bg-stone-800 border border-stone-600 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-amber-500" />
            </div>
            <div>
              <label class="block text-stone-400 text-sm mb-1">ì¤„ê±°ë¦¬ (ì„ íƒ)</label>
              <textarea id="recordOverview" rows="2" placeholder="ì‘í’ˆ ì¤„ê±°ë¦¬..."
                class="w-full rounded-lg bg-stone-800 border border-stone-600 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-amber-500 resize-none"></textarea>
            </div>
          </div>
          <div>
            <label class="block text-stone-400 text-sm mb-1">ê³µìœ  ë°©ì‹</label>
            <select id="recordMethod" class="w-full rounded-lg bg-stone-800 border border-stone-600 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-amber-500">
              <option value="image">ì´ë¯¸ì§€</option>
              <option value="link">ë§í¬</option>
            </select>
          </div>
          <button id="btnAddRecord" class="w-full py-3 rounded-lg bg-amber-600 hover:bg-amber-500 font-medium transition-colors">
            ê³µìœ  ê¸°ë¡ ì¶”ê°€ (KV)
          </button>
        </div>
      </div>

      <!-- í•„í„° ë° ê´€ë¦¬ -->
      <div class="p-4 rounded-lg bg-stone-800/50 border border-stone-700">
        <h2 class="text-lg font-semibold text-amber-600/90 mb-4">í•„í„° ë° ê´€ë¦¬</h2>
        <div class="space-y-3">
          <div>
            <label class="block text-stone-400 text-sm mb-1">ì‘í’ˆ í•„í„°</label>
            <select id="filterTitle" class="w-full rounded-lg bg-stone-800 border border-stone-600 px-4 py-2 focus:outline-none focus:ring-2 focus:ring-amber-500">
              <option value="">ëª¨ë“  ì‘í’ˆ</option>
            </select>
          </div>
          <div class="flex gap-2">
            <button id="btnRefresh" class="flex-1 py-2 px-4 rounded-lg bg-stone-700 hover:bg-stone-600 font-medium transition-colors text-sm">
              ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            </button>
            <button id="btnClear" class="flex-1 py-2 px-4 rounded-lg bg-red-900/50 hover:bg-red-900 font-medium transition-colors text-sm text-red-200">
              ì„ íƒ ì‘í’ˆ ì‚­ì œ
            </button>
          </div>
          <div class="pt-2 border-t border-stone-700">
            <div class="text-stone-400 text-xs">
              <div>ì´ ê¸°ë¡: <span id="totalCount" class="text-amber-400 font-bold">0</span>ê°œ</div>
              <div>ì‘í’ˆ ìˆ˜: <span id="titleCount" class="text-amber-400 font-bold">0</span>ê°œ</div>
              <div>KV ì—°ê²° ìƒíƒœ: <span id="kvStatus" class="text-amber-400 font-bold">í™•ì¸ ì¤‘...</span></div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div id="status" class="mb-4 text-stone-400 text-sm min-h-[1.5rem]"></div>

    <h2 class="text-lg font-semibold text-stone-300 mb-2">ê³µìœ  ê¸°ë¡ ëª©ë¡</h2>
    <div id="recordList" class="space-y-2 mb-8"></div>

    <h2 class="text-lg font-semibold text-stone-300 mb-2">API ì‘ë‹µ (ìµœê·¼)</h2>
    <pre id="apiResponse" class="p-4 rounded-lg bg-stone-950 border border-stone-700 text-xs text-stone-400 overflow-x-auto min-h-[80px] max-h-96 overflow-y-auto"></pre>
  </div>

  <script>
    const API_BASE = window.location.origin;

    function escapeHtml(s) {
      const div = document.createElement("div");
      div.textContent = s;
      return div.innerHTML;
    }

    function setStatus(msg, isError = false) {
      const el = document.getElementById("status");
      el.textContent = msg;
      el.className = "mb-4 text-sm min-h-[1.5rem] " + (isError ? "text-red-400" : "text-stone-400");
    }

    function logApiResponse(data) {
      const el = document.getElementById("apiResponse");
      el.textContent = JSON.stringify(data, null, 2);
    }

    async function addSharedRecord(title, type, data, shareMethod) {
      try {
        const res = await fetch(`${API_BASE}/api/shared-records`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ title, type, data, shareMethod }),
        });
        const result = await res.json();
        logApiResponse(result);
        if (!res.ok) {
          throw new Error(result.error || "ì €ì¥ ì‹¤íŒ¨");
        }
        return result.recordId;
      } catch (err) {
        throw new Error("KV ì €ì¥ ì‹¤íŒ¨: " + err.message);
      }
    }

    async function getSharedRecords(title) {
      try {
        const url = title 
          ? `${API_BASE}/api/shared-records?title=${encodeURIComponent(title)}`
          : `${API_BASE}/api/shared-records`;
        const res = await fetch(url);
        const result = await res.json();
        logApiResponse(result);
        if (!res.ok) {
          throw new Error(result.error || "ì¡°íšŒ ì‹¤íŒ¨");
        }
        return result.records || [];
      } catch (err) {
        throw new Error("KV ì¡°íšŒ ì‹¤íŒ¨: " + err.message);
      }
    }

    async function deleteSharedRecord(title, recordId) {
      try {
        const res = await fetch(`${API_BASE}/api/shared-records`, {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ title, recordId }),
        });
        const result = await res.json();
        logApiResponse(result);
        if (!res.ok) {
          throw new Error(result.error || "ì‚­ì œ ì‹¤íŒ¨");
        }
        return result.success;
      } catch (err) {
        throw new Error("KV ì‚­ì œ ì‹¤íŒ¨: " + err.message);
      }
    }

    async function getTitles() {
      try {
        const res = await fetch(`${API_BASE}/api/shared-records/titles`);
        const result = await res.json();
        if (!res.ok) {
          throw new Error(result.error || "ì‘í’ˆ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨");
        }
        return result.titles || [];
      } catch (err) {
        console.warn("ì‘í’ˆ ëª©ë¡ ì¡°íšŒ ì‹¤íŒ¨:", err);
        return [];
      }
    }

    async function updateFilter() {
      const filter = document.getElementById("filterTitle");
      try {
        const titles = await getTitles();
        filter.innerHTML = '<option value="">ëª¨ë“  ì‘í’ˆ</option>';
        titles.forEach((item) => {
          const option = document.createElement("option");
          option.value = item.title;
          option.textContent = `${item.title} (${item.count}ê°œ)`;
          filter.appendChild(option);
        });
      } catch (err) {
        filter.innerHTML = '<option value="">ëª¨ë“  ì‘í’ˆ</option>';
      }
    }

    async function render() {
      const filter = document.getElementById("filterTitle");
      const selectedTitle = filter ? filter.value : "";
      
      try {
        const records = await getSharedRecords(selectedTitle);
        const allRecords = await getSharedRecords();
        const titles = await getTitles();

        // í†µê³„ ì—…ë°ì´íŠ¸
        document.getElementById("totalCount").textContent = allRecords.length;
        document.getElementById("titleCount").textContent = titles.length;
        document.getElementById("kvStatus").textContent = "ì—°ê²°ë¨ âœ“";
        document.getElementById("kvStatus").className = "text-green-400 font-bold";

        // ëª©ë¡ ë Œë”ë§
        const listEl = document.getElementById("recordList");
        listEl.innerHTML = "";
        
        if (records.length === 0) {
          listEl.innerHTML = '<div class="text-stone-400 text-center py-8">ê³µìœ  ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
          return;
        }

        records.forEach((record) => {
          const date = new Date(record.sharedAt);
          const dateStr = date.toLocaleDateString("ko-KR", { 
            year: "numeric", 
            month: "short", 
            day: "numeric", 
            hour: "2-digit", 
            minute: "2-digit" 
          });
          const methodIcon = record.shareMethod === "image" ? "ğŸ“œ" : "ğŸ”—";
          const typeText = record.type === "book" ? "ì±… ì „ì²´" : "Q&A";
          const title = record.title || "(ì œëª© ì—†ìŒ)";

          const div = document.createElement("div");
          div.className = "p-4 rounded-lg bg-stone-800/80 border border-stone-700 hover:border-amber-600/50 transition-colors";
          div.innerHTML = `
            <div class="flex items-start justify-between gap-4">
              <div class="flex-1">
                <div class="font-medium text-amber-600/90 mb-1">${escapeHtml(title)}</div>
                <div class="text-stone-400 text-sm mb-2">${methodIcon} ${typeText} Â· ${dateStr}</div>
                <div class="text-stone-300 text-xs">${escapeHtml(record.preview || "")}</div>
                ${record.type === "book" ? `
                  <div class="mt-2 text-stone-500 text-xs">
                    ì§ˆë¬¸ ${record.data.questions?.length || 0}ê°œ
                    ${record.data.overview ? `Â· ì¤„ê±°ë¦¬: ${escapeHtml(record.data.overview.slice(0, 50))}${record.data.overview.length > 50 ? "â€¦" : ""}` : ""}
                  </div>
                ` : `
                  <div class="mt-2 text-stone-500 text-xs">
                    Q. ${escapeHtml((record.data.q || "").slice(0, 60))}${(record.data.q || "").length > 60 ? "â€¦" : ""}
                  </div>
                  <div class="text-stone-500 text-xs">
                    A. ${escapeHtml((record.data.a || "").slice(0, 60))}${(record.data.a || "").length > 60 ? "â€¦" : ""}
                  </div>
                `}
              </div>
              <button onclick="deleteRecord('${escapeHtml(title)}', '${record.id}')" 
                class="text-red-400 hover:text-red-300 text-xl px-2 flex-shrink-0" 
                title="ì‚­ì œ">Ã—</button>
            </div>
          `;
          listEl.appendChild(div);
        });
      } catch (err) {
        document.getElementById("kvStatus").textContent = "ì—°ê²° ì‹¤íŒ¨ âœ—";
        document.getElementById("kvStatus").className = "text-red-400 font-bold";
        setStatus("KV ì¡°íšŒ ì‹¤íŒ¨: " + err.message, true);
        const listEl = document.getElementById("recordList");
        listEl.innerHTML = '<div class="text-red-400 text-center py-8">KV ì—°ê²° ì‹¤íŒ¨: ' + escapeHtml(err.message) + '</div>';
      }
    }

    async function deleteRecord(title, recordId) {
      if (!confirm("ì´ ê³µìœ  ê¸°ë¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
      try {
        await deleteSharedRecord(title, recordId);
        setStatus("ê³µìœ  ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
        await updateFilter();
        await render();
      } catch (err) {
        setStatus("ì‚­ì œ ì‹¤íŒ¨: " + err.message, true);
      }
    }

    // íƒ€ì… ë³€ê²½ ì‹œ í•„ë“œ í‘œì‹œ/ìˆ¨ê¹€
    document.getElementById("recordType").addEventListener("change", function() {
      const type = this.value;
      document.getElementById("qaFields").style.display = type === "qa" ? "block" : "none";
      document.getElementById("bookFields").style.display = type === "book" ? "block" : "none";
    });

    // ê³µìœ  ê¸°ë¡ ì¶”ê°€
    document.getElementById("btnAddRecord").addEventListener("click", async function() {
      const title = document.getElementById("recordTitle").value.trim();
      const type = document.getElementById("recordType").value;
      const method = document.getElementById("recordMethod").value;

      if (!title) {
        setStatus("ì‘í’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš”.", true);
        return;
      }

      let data;
      if (type === "qa") {
        const q = document.getElementById("recordQ").value.trim();
        const a = document.getElementById("recordA").value.trim();
        if (!q) {
          setStatus("ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”.", true);
          return;
        }
        data = { q, a };
      } else {
        const qCount = parseInt(document.getElementById("recordQCount").value) || 5;
        const overview = document.getElementById("recordOverview").value.trim();
        const questions = Array.from({ length: qCount }, (_, i) => ({
          q: `ìƒ˜í”Œ ì§ˆë¬¸ ${i + 1}`,
          a: `ìƒ˜í”Œ ë‹µë³€ ${i + 1}`,
          options: i < 2 ? ["ì„ íƒì§€1", "ì„ íƒì§€2", "ì„ íƒì§€3"] : undefined
        }));
        data = {
          title: title,
          questions: questions,
          overview: overview
        };
      }

      try {
        this.disabled = true;
        this.textContent = "ì €ì¥ ì¤‘...";
        const recordId = await addSharedRecord(title, type, data, method);
        setStatus(`ê³µìœ  ê¸°ë¡ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤. (ID: ${recordId.slice(0, 8)}â€¦)`);
        
        // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
        document.getElementById("recordTitle").value = "";
        document.getElementById("recordQ").value = "";
        document.getElementById("recordA").value = "";
        document.getElementById("recordOverview").value = "";
        
        await updateFilter();
        await render();
      } catch (err) {
        setStatus("ì €ì¥ ì‹¤íŒ¨: " + err.message, true);
      } finally {
        this.disabled = false;
        this.textContent = "ê³µìœ  ê¸°ë¡ ì¶”ê°€ (KV)";
      }
    });

    // í•„í„° ë³€ê²½
    document.getElementById("filterTitle").addEventListener("change", render);

    // ìƒˆë¡œê³ ì¹¨
    document.getElementById("btnRefresh").addEventListener("click", async function() {
      await updateFilter();
      await render();
      setStatus("ëª©ë¡ì„ ìƒˆë¡œê³ ì¹¨í–ˆìŠµë‹ˆë‹¤.");
    });

    // ì„ íƒ ì‘í’ˆ ì‚­ì œ
    document.getElementById("btnClear").addEventListener("click", async function() {
      const filter = document.getElementById("filterTitle");
      const selectedTitle = filter.value;
      if (!selectedTitle) {
        setStatus("ì‚­ì œí•  ì‘í’ˆì„ ì„ íƒí•˜ì„¸ìš”.", true);
        return;
      }
      if (!confirm(`"${selectedTitle}"ì˜ ëª¨ë“  ê³µìœ  ê¸°ë¡ì„ ì‚­ì œí• ê¹Œìš”?`)) return;
      
      try {
        const records = await getSharedRecords(selectedTitle);
        let deleted = 0;
        for (const record of records) {
          await deleteSharedRecord(selectedTitle, record.id);
          deleted++;
        }
        setStatus(`${deleted}ê°œì˜ ê¸°ë¡ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
        await updateFilter();
        await render();
      } catch (err) {
        setStatus("ì‚­ì œ ì‹¤íŒ¨: " + err.message, true);
      }
    });

    // ì´ˆê¸°í™”
    (async function() {
      await updateFilter();
      await render();
      setStatus("Vercel KV ê³µìœ  ê¸°ë¡ì„ ì¶”ê°€í•˜ê±°ë‚˜ í•„í„°ë¥¼ ì‚¬ìš©í•˜ì—¬ ì¡°íšŒí•˜ì„¸ìš”.");
    })();
  </script>
</body>
</html>
