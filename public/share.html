<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="google-adsense-account" content="ca-pub-3543643898299039">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê³µìœ ëœ ì„œê³  - ë§ˆë²•ì‚¬ì˜ ì„œê³ </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://t1.kakaocdn.net/kakao_js_sdk/2.7.9/kakao.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+KR:wght@400;700&family=Nanum+Brush+Script&display=swap');

        :root {
            --ancient-gold: #c5a059;
            --stone-medium: #1a1a1f;
            --stone-dark: #0a0a0c;
            --leather-rich: #3d2b1f;
            --parchment: #f2e8cf;
        }

        body {
            font-family: 'Noto Serif KR', serif;
            background: radial-gradient(circle at center, #1a1a24 0%, #08080a 100%);
            color: #e2e2e2;
            overflow-x: hidden;
            min-height: 100vh;
        }

        .library-bg {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            opacity: 0.5;
            display: flex;
            justify-content: space-around;
            align-items: flex-end;
            padding: 0;
            pointer-events: none;
        }

        .book-stack {
            width: 130px;
            display: flex;
            flex-direction: column-reverse;
            margin: 0 -20px; 
        }

        .bg-book {
            height: 12px;
            margin-bottom: 2px;
            background: #1e1e24;
            border-bottom: 1px solid rgba(255,255,255,0.03);
            border-left: 8px solid rgba(0,0,0,0.5); 
            width: 100%;
            border-radius: 1px;
        }

        .god-rays {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(circle at 50% -5%, rgba(197, 160, 89, 0.25) 0%, transparent 85%);
            pointer-events: none;
            z-index: 1;
        }

        .magic-dust {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            background-image: radial-gradient(circle, #fff 1px, transparent 1px);
            background-size: 100px 100px;
            opacity: 0.1;
            animation: moveDust 45s linear infinite;
            z-index: 0;
        }

        @keyframes moveDust {
            from { background-position: 0 0; }
            to { background-position: 1000px 1000px; }
        }

        .gold-btn {
            background: rgba(197, 160, 89, 0.1);
            border: 1px solid var(--ancient-gold);
            color: var(--ancient-gold);
            padding: 8px 16px;
            font-weight: bold;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .gold-btn:hover:not(:disabled) {
            background: var(--ancient-gold);
            color: #000;
            box-shadow: 0 0 20px var(--ancient-gold);
        }

        .gold-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .book-card {
            background: rgba(20, 20, 28, 0.95);
            border: 1px solid var(--ancient-gold);
            border-radius: 8px;
            padding: 24px;
            margin-bottom: 20px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .book-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(197, 160, 89, 0.3);
            border-color: var(--ancient-gold);
        }

        .book-title {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--ancient-gold);
            margin-bottom: 12px;
        }

        .question-item {
            background: rgba(0, 0, 0, 0.3);
            border-left: 3px solid var(--ancient-gold);
            padding: 12px 16px;
            margin-bottom: 12px;
            border-radius: 4px;
        }

        .question-text {
            font-weight: bold;
            color: #e2e2e2;
            margin-bottom: 8px;
        }

        .answer-text {
            color: rgba(226, 226, 226, 0.8);
            white-space: pre-wrap;
            line-height: 1.6;
        }

        .empty-answer {
            color: rgba(226, 226, 226, 0.4);
            font-style: italic;
        }

        .tab-button {
            background: rgba(197, 160, 89, 0.1);
            border: 1px solid var(--ancient-gold);
            color: var(--ancient-gold);
            padding: 10px 20px;
            margin-right: 8px;
            margin-bottom: 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .tab-button.active {
            background: var(--ancient-gold);
            color: #000;
        }

        .tab-button:hover {
            background: rgba(197, 160, 89, 0.2);
        }

        .title-select {
            background: rgba(0, 0, 0, 0.4);
            border: 1px solid var(--ancient-gold);
            color: var(--ancient-gold);
            padding: 8px 16px;
            border-radius: 4px;
            font-size: 14px;
            min-width: 200px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--ancient-gold);
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: rgba(226, 226, 226, 0.6);
        }

        @media (max-width: 768px) {
            .book-card {
                padding: 16px;
            }
            .book-title {
                font-size: 1.25rem;
            }
            .tab-button {
                padding: 8px 16px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body class="p-4 md:p-10 pt-10">
    <div class="library-bg" id="bg-stacks"></div>
    <div class="god-rays"></div>
    <div class="magic-dust"></div>

    <main class="max-w-6xl mx-auto relative z-10">
        <!-- ìƒë‹¨ í—¤ë” -->
        <div class="flex flex-wrap items-center justify-between gap-6 mb-12 px-4">
            <div class="flex items-center gap-6">
                <span class="text-4xl opacity-50">ğŸ“š</span>
                <h1 class="text-xl md:text-2xl font-bold tracking-[0.2em] text-stone-400 uppercase">ê³µìœ ëœ ì„œê³ </h1>
            </div>
            <div class="flex gap-2">
                <a href="/" class="gold-btn text-[10px] tracking-widest px-4 py-2 no-underline">ğŸ  í™ˆìœ¼ë¡œ</a>
            </div>
        </div>

        <!-- íƒ­ ë²„íŠ¼ -->
        <div class="mb-8 px-4 flex flex-wrap">
            <button class="tab-button active" onclick="switchTab('random')" id="tab-random">ğŸ² ëœë¤ ì±… ë³´ê¸°</button>
            <button class="tab-button" onclick="switchTab('by-title')" id="tab-by-title">ğŸ“– ì‘í’ˆë³„ ë³´ê¸°</button>
            <button class="tab-button" onclick="switchTab('my-books')" id="tab-my-books">â­ ë‚´ê°€ ê³µìœ í•œ ì±…</button>
        </div>

        <!-- ì‘í’ˆë³„ ì„ íƒ ì˜ì—­ -->
        <div id="title-select-area" class="mb-6 px-4" style="display: none;">
            <select id="title-select" class="title-select" onchange="loadBooksByTitle()">
                <option value="">ì‘í’ˆì„ ì„ íƒí•˜ì„¸ìš”...</option>
            </select>
        </div>

        <!-- ì½˜í…ì¸  ì˜ì—­ -->
        <div id="content-area" class="px-4">
            <div class="loading">ë¡œë”© ì¤‘...</div>
        </div>
    </main>

    <script>
        const API_BASE = window.location.origin;
        let kakaoUserId = null;
        let currentTab = 'random';
        let allTitles = [];

        // ë°°ê²½ ì±… ë”ë¯¸ ìƒì„±
        function createBgStacks() {
            const container = document.getElementById('bg-stacks');
            if(!container) return;
            const stackCount = 14; 
            for(let i = 0; i < stackCount; i++) {
                const stack = document.createElement('div');
                stack.className = 'book-stack';
                const height = Math.floor(Math.random() * 30) + 15; 
                for(let j = 0; j < height; j++) {
                    const book = document.createElement('div');
                    book.className = 'bg-book';
                    book.style.width = (75 + Math.random() * 45) + '%';
                    const hue = 210 + Math.random() * 40;
                    book.style.backgroundColor = `hsl(${hue}, 15%, ${12 + Math.random() * 15}%)`;
                    stack.appendChild(book);
                }
                container.appendChild(stack);
            }
        }

        // ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ í™•ì¸
        async function checkKakaoLogin() {
            const savedUserId = localStorage.getItem('kakao_user_id');
            if (savedUserId) {
                kakaoUserId = savedUserId;
                return true;
            }
            return false;
        }

        // íƒ­ ì „í™˜
        function switchTab(tab) {
            currentTab = tab;
            
            // íƒ­ ë²„íŠ¼ í™œì„±í™”
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            
            // ì‘í’ˆ ì„ íƒ ì˜ì—­ í‘œì‹œ/ìˆ¨ê¹€
            const titleSelectArea = document.getElementById('title-select-area');
            if (tab === 'by-title') {
                titleSelectArea.style.display = 'block';
                loadTitles();
            } else {
                titleSelectArea.style.display = 'none';
            }
            
            // ì½˜í…ì¸  ë¡œë“œ
            if (tab === 'random') {
                loadRandomBook();
            } else if (tab === 'by-title') {
                const selectedTitle = document.getElementById('title-select').value;
                if (selectedTitle) {
                    loadBooksByTitle();
                } else {
                    showEmpty('ì‘í’ˆì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                }
            } else if (tab === 'my-books') {
                loadMyBooks();
            }
        }

        // ì‘í’ˆ ëª©ë¡ ë¡œë“œ
        async function loadTitles() {
            try {
                const res = await fetch(`${API_BASE}/api/shared-records/titles`);
                const data = await res.json();
                
                if (data.titles && data.titles.length > 0) {
                    allTitles = data.titles;
                    const select = document.getElementById('title-select');
                    select.innerHTML = '<option value="">ì‘í’ˆì„ ì„ íƒí•˜ì„¸ìš”...</option>';
                    data.titles.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item.title;
                        option.textContent = `${item.title} (${item.count}ê°œ)`;
                        select.appendChild(option);
                    });
                } else {
                    document.getElementById('title-select').innerHTML = '<option value="">ê³µìœ ëœ ì‘í’ˆì´ ì—†ìŠµë‹ˆë‹¤</option>';
                }
            } catch (err) {
                console.error('ì‘í’ˆ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', err);
            }
        }

        // ëœë¤ ì±… ë¡œë“œ
        async function loadRandomBook() {
            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = '<div class="loading">ëœë¤ ì±…ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
            
            try {
                const res = await fetch(`${API_BASE}/api/shared-records`);
                const data = await res.json();
                
                if (!data.records || data.records.length === 0) {
                    showEmpty('ê³µìœ ëœ ì±…ì´ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                // book íƒ€ì…ë§Œ í•„í„°ë§
                const bookRecords = data.records.filter(r => r.type === 'book');
                if (bookRecords.length === 0) {
                    showEmpty('ê³µìœ ëœ ì±…ì´ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                // ëœë¤ ì„ íƒ
                const randomRecord = bookRecords[Math.floor(Math.random() * bookRecords.length)];
                displayBook(randomRecord);
            } catch (err) {
                console.error('ëœë¤ ì±… ë¡œë“œ ì‹¤íŒ¨:', err);
                contentArea.innerHTML = '<div class="empty-state">ì±…ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
            }
        }

        // ì‘í’ˆë³„ ì±… ë¡œë“œ
        async function loadBooksByTitle() {
            const selectedTitle = document.getElementById('title-select').value;
            if (!selectedTitle) {
                return;
            }
            
            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = '<div class="loading">ì±…ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
            
            try {
                const res = await fetch(`${API_BASE}/api/shared-records?title=${encodeURIComponent(selectedTitle)}`);
                const data = await res.json();
                
                if (!data.records || data.records.length === 0) {
                    showEmpty('ì´ ì‘í’ˆì— ëŒ€í•œ ê³µìœ  ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                // book íƒ€ì…ë§Œ í•„í„°ë§
                const bookRecords = data.records.filter(r => r.type === 'book');
                if (bookRecords.length === 0) {
                    showEmpty('ì´ ì‘í’ˆì— ëŒ€í•œ ê³µìœ ëœ ì±…ì´ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                // ìµœì‹ ìˆœ ì •ë ¬
                bookRecords.sort((a, b) => new Date(b.sharedAt) - new Date(a.sharedAt));
                
                displayBooks(bookRecords);
            } catch (err) {
                console.error('ì‘í’ˆë³„ ì±… ë¡œë“œ ì‹¤íŒ¨:', err);
                contentArea.innerHTML = '<div class="empty-state">ì±…ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
            }
        }

        // ë‚´ê°€ ê³µìœ í•œ ì±… ë¡œë“œ
        async function loadMyBooks() {
            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = '<div class="loading">ë‚´ ì±…ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
            
            // ë¡œê·¸ì¸ í™•ì¸
            const isLoggedIn = await checkKakaoLogin();
            if (!isLoggedIn) {
                contentArea.innerHTML = '<div class="empty-state">ë‚´ê°€ ê³µìœ í•œ ì±…ì„ ë³´ë ¤ë©´ ì¹´ì¹´ì˜¤ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.<br><br><a href="/" class="gold-btn inline-block">í™ˆìœ¼ë¡œ ê°€ê¸°</a></div>';
                return;
            }
            
            try {
                const res = await fetch(`${API_BASE}/api/shared-records`);
                const data = await res.json();
                
                if (!data.records || data.records.length === 0) {
                    showEmpty('ê³µìœ í•œ ì±…ì´ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                // ë‚´ê°€ ê³µìœ í•œ book íƒ€ì…ë§Œ í•„í„°ë§
                const myBookRecords = data.records.filter(r => r.type === 'book' && r.userId === kakaoUserId);
                if (myBookRecords.length === 0) {
                    showEmpty('ê³µìœ í•œ ì±…ì´ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                // ìµœì‹ ìˆœ ì •ë ¬
                myBookRecords.sort((a, b) => new Date(b.sharedAt) - new Date(a.sharedAt));
                
                displayBooks(myBookRecords);
            } catch (err) {
                console.error('ë‚´ ì±… ë¡œë“œ ì‹¤íŒ¨:', err);
                contentArea.innerHTML = '<div class="empty-state">ì±…ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
            }
        }

        // ì±… í‘œì‹œ (ë‹¨ì¼)
        function displayBook(record) {
            const contentArea = document.getElementById('content-area');
            const bookData = record.data || {};
            const questions = bookData.questions || [];
            
            let html = '<div class="book-card">';
            html += `<div class="book-title">${escapeHtml(bookData.title || record.title || 'ì œëª© ì—†ìŒ')}</div>`;
            
            if (bookData.overview) {
                html += `<div style="color: rgba(226, 226, 226, 0.7); margin-bottom: 20px; line-height: 1.6;">${escapeHtml(bookData.overview)}</div>`;
            }
            
            if (questions.length === 0) {
                html += '<div class="empty-state">ì§ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            } else {
                questions.forEach((item, index) => {
                    html += '<div class="question-item">';
                    html += `<div class="question-text">Q${index + 1}. ${escapeHtml(item.q || '')}</div>`;
                    if (item.a && item.a.trim()) {
                        html += `<div class="answer-text">${escapeHtml(item.a)}</div>`;
                    } else {
                        html += '<div class="empty-answer">(ë‹µë³€ ì—†ìŒ)</div>';
                    }
                    html += '</div>';
                });
            }
            
            html += `<div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid rgba(197, 160, 89, 0.2); font-size: 12px; color: rgba(226, 226, 226, 0.5);">`;
            html += `ê³µìœ ì¼: ${new Date(record.sharedAt).toLocaleString('ko-KR')}`;
            html += '</div>';
            html += '</div>';
            
            // ëœë¤ íƒ­ì¸ ê²½ìš° ìƒˆë¡œê³ ì¹¨ ë²„íŠ¼ ì¶”ê°€
            if (currentTab === 'random') {
                html += '<div style="text-align: center; margin-top: 20px;">';
                html += '<button class="gold-btn" onclick="loadRandomBook()">ğŸ² ë‹¤ë¥¸ ì±… ë³´ê¸°</button>';
                html += '</div>';
            }
            
            contentArea.innerHTML = html;
        }

        // ì±… í‘œì‹œ (ì—¬ëŸ¬ ê°œ)
        function displayBooks(records) {
            const contentArea = document.getElementById('content-area');
            
            if (records.length === 0) {
                showEmpty('í‘œì‹œí•  ì±…ì´ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            let html = '';
            records.forEach(record => {
                const bookData = record.data || {};
                const questions = bookData.questions || [];
                
                html += '<div class="book-card">';
                html += `<div class="book-title">${escapeHtml(bookData.title || record.title || 'ì œëª© ì—†ìŒ')}</div>`;
                
                if (bookData.overview) {
                    html += `<div style="color: rgba(226, 226, 226, 0.7); margin-bottom: 20px; line-height: 1.6;">${escapeHtml(bookData.overview)}</div>`;
                }
                
                if (questions.length === 0) {
                    html += '<div class="empty-state">ì§ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                } else {
                    questions.forEach((item, index) => {
                        html += '<div class="question-item">';
                        html += `<div class="question-text">Q${index + 1}. ${escapeHtml(item.q || '')}</div>`;
                        if (item.a && item.a.trim()) {
                            html += `<div class="answer-text">${escapeHtml(item.a)}</div>`;
                        } else {
                            html += '<div class="empty-answer">(ë‹µë³€ ì—†ìŒ)</div>';
                        }
                        html += '</div>';
                    });
                }
                
                html += `<div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid rgba(197, 160, 89, 0.2); font-size: 12px; color: rgba(226, 226, 226, 0.5);">`;
                html += `ê³µìœ ì¼: ${new Date(record.sharedAt).toLocaleString('ko-KR')}`;
                html += '</div>';
                html += '</div>';
            });
            
            contentArea.innerHTML = html;
        }

        // ë¹ˆ ìƒíƒœ í‘œì‹œ
        function showEmpty(message) {
            const contentArea = document.getElementById('content-area');
            contentArea.innerHTML = `<div class="empty-state">${message}</div>`;
        }

        // HTML ì´ìŠ¤ì¼€ì´í”„
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ì´ˆê¸°í™”
        window.addEventListener('load', function() {
            createBgStacks();
            checkKakaoLogin();
            loadRandomBook();
        });
    </script>
</body>
</html>
